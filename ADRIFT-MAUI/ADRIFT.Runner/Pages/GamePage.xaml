<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="ADRIFT.Runner.Pages.GamePage"
             Title="ADRIFT Runner">

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Map" Clicked="OnToggleMap" />
        <ToolbarItem Text="Inventory" Clicked="OnToggleInventory" />
        <ToolbarItem Text="Save" Clicked="OnSaveGame" />
        <ToolbarItem Text="Load" Clicked="OnLoadGame" />
        <ToolbarItem Text="Undo" Clicked="OnUndo" />
        <ToolbarItem Text="Hints" Clicked="OnShowHints" />
        <ToolbarItem Text="Export" Clicked="OnExportTranscript" />
        <ToolbarItem Text="Restart" Clicked="OnRestartGame" />
    </ContentPage.ToolbarItems>

    <Grid RowDefinitions="Auto,*,Auto,Auto,Auto" ColumnDefinitions="*,Auto" Padding="10">

        <!-- Map Panel (collapsible, at top) -->
        <Border Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="2"
                x:Name="MapPanel"
                IsVisible="False"
                BackgroundColor="{DynamicResource SecondaryBackgroundColor}"
                Stroke="{DynamicResource BorderColor}"
                StrokeThickness="1"
                Padding="10"
                Margin="0,0,0,10"
                HeightRequest="250">
            <VerticalStackLayout Spacing="10">
                <Label Text="Adventure Map"
                       FontSize="16"
                       FontAttributes="Bold"
                       HorizontalOptions="Center" />
                <BoxView HeightRequest="1" Color="{DynamicResource BorderColor}" />
                <!-- Map view will be added programmatically -->
                <Grid x:Name="MapContainer" HeightRequest="200" />
            </VerticalStackLayout>
        </Border>

        <!-- Output area with HTML rendering -->
        <WebView x:Name="OutputWebView" Grid.Row="1" Grid.Column="0" Grid.RowSpan="4" />

        <!-- Hidden ScrollView fallback (legacy support) -->
        <ScrollView x:Name="OutputScroll" Grid.Row="1" Grid.Column="0" IsVisible="False">
            <VerticalStackLayout x:Name="OutputStack" Spacing="10" Padding="10">
                <Label x:Name="OutputLabel"
                       Text=""
                       FontFamily="Courier New"
                       FontSize="14"
                       TextColor="{DynamicResource PrimaryTextColor}"
                       LineBreakMode="WordWrap" />
            </VerticalStackLayout>
        </ScrollView>

        <!-- Inventory Panel (collapsible) -->
        <Border Grid.Row="1" Grid.Column="1" Grid.RowSpan="4"
                x:Name="InventoryPanel"
                IsVisible="False"
                BackgroundColor="{DynamicResource SecondaryBackgroundColor}"
                Stroke="{DynamicResource BorderColor}"
                StrokeThickness="1"
                Padding="10"
                WidthRequest="250">
            <VerticalStackLayout Spacing="10">
                <Label Text="Inventory"
                       FontSize="16"
                       FontAttributes="Bold"
                       HorizontalOptions="Center" />

                <BoxView HeightRequest="1" Color="{DynamicResource BorderColor}" />

                <ScrollView VerticalOptions="FillAndExpand">
                    <VerticalStackLayout x:Name="InventoryList" Spacing="5">
                        <Label Text="(empty)"
                               x:Name="EmptyInventoryLabel"
                               FontSize="12"
                               FontStyle="Italic"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"
                               TextColor="{DynamicResource SecondaryTextColor}" />
                    </VerticalStackLayout>
                </ScrollView>
            </VerticalStackLayout>
        </Border>

        <!-- Status bar -->
        <Grid Grid.Row="2" Grid.Column="0" ColumnDefinitions="*,*,*" Padding="5" BackgroundColor="{DynamicResource SecondaryColor}">
            <Label Grid.Column="0" x:Name="ScoreLabel" Text="Score: 0" FontSize="12" VerticalOptions="Center" />
            <Label Grid.Column="1" x:Name="TurnsLabel" Text="Turns: 0" FontSize="12" VerticalOptions="Center" HorizontalOptions="Center" />
            <Label Grid.Column="2" x:Name="LocationLabel" Text="" FontSize="12" VerticalOptions="Center" HorizontalOptions="End" />
        </Grid>

        <!-- Autocomplete suggestions (collapsible) -->
        <Border Grid.Row="3" Grid.Column="0"
                x:Name="AutocompletePanel"
                IsVisible="False"
                BackgroundColor="{DynamicResource SecondaryBackgroundColor}"
                Stroke="{DynamicResource BorderColor}"
                StrokeThickness="1"
                Padding="5"
                Margin="5,0,5,0"
                MaximumHeightRequest="150">
            <CollectionView x:Name="SuggestionsList"
                            SelectionMode="Single"
                            SelectionChanged="OnSuggestionSelected">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Label Text="{Binding}"
                               FontFamily="Courier New"
                               FontSize="12"
                               Padding="5,3" />
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Border>

        <!-- Input area -->
        <Grid Grid.Row="4" Grid.Column="0" ColumnDefinitions="Auto,*,Auto,Auto" Padding="10" ColumnSpacing="5">
            <Button Grid.Column="0"
                    Text="↑"
                    Clicked="OnHistoryUp"
                    WidthRequest="40"
                    ToolTipProperties.Text="Previous command" />

            <Entry x:Name="CommandEntry"
                   Grid.Column="1"
                   Placeholder="Enter command..."
                   FontFamily="Courier New"
                   FontSize="14"
                   TextChanged="OnCommandTextChanged"
                   Completed="OnCommandEntered"
                   ReturnCommand="{Binding SubmitCommandCommand}" />

            <Button Grid.Column="2"
                    Text="↓"
                    Clicked="OnHistoryDown"
                    WidthRequest="40"
                    ToolTipProperties.Text="Next command" />

            <Button Grid.Column="3"
                    Text="Send"
                    Clicked="OnCommandEntered"
                    WidthRequest="80" />
        </Grid>

    </Grid>

</ContentPage>
